<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
  .weather-card { transition: transform 0.2s; }
  .weather-card:hover { transform: translateY(-2px); }
  .suggestions-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; max-height: 200px; overflow-y: auto; display: none; z-index:1000; }
  .suggestion-item { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 1px solid #eee; }
  .suggestion-item:hover { background-color: #f8f9fa; }
  .suggestion-item:last-child { border-bottom: none; }
</style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/"><i class="fas fa-cloud-sun me-2"></i>Weather Portal</a>
    <div class="navbar-nav ms-auto">
      <span class="navbar-text me-3" id="userInfo">Welcome!</span>
      <button class="btn btn-outline-light" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="row">
    <!-- Left: Search & Weather -->
    <div class="col-md-8">
      <!-- Search Card -->
      <div class="card shadow">
        <div class="card-header bg-primary text-white"><h4 class="mb-0"><i class="fas fa-search me-2"></i>Weather Search</h4></div>
        <div class="card-body">
          <form id="weatherForm">
            <div class="row">
              <div class="col-md-8 position-relative">
                <input type="text" class="form-control" id="cityInput" placeholder="Enter city name..." required autocomplete="off">
                <div id="suggestions" class="suggestions-dropdown"></div>
              </div>
              <div class="col-md-4">
                <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search me-2"></i>Search Weather</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Weather Result Card -->
      <div id="weatherResult" class="mt-4" style="display: none;">
        <div class="card shadow">
          <div class="card-header bg-success text-white"><h5 class="mb-0"><i class="fas fa-cloud me-2"></i>Weather Information</h5></div>
          <div class="card-body">
            <h3 id="cityName" class="text-primary"></h3>
            <h1 id="temperature" class="display-4 text-info"></h1>
            <p id="description" class="lead"></p>
            <div class="mt-3">
              <label class="form-label fw-bold">Display Unit:</label>
              <select id="displayUnit" class="form-select w-50" onchange="updateDisplayedTemperature()">
                <option value="celsius" selected>Celsius (°C)</option>
                <option value="fahrenheit">Fahrenheit (°F)</option>
                <option value="kelvin">Kelvin (K)</option>
              </select>
            </div>
            <div class="mt-3">
              <button class="btn btn-success" onclick="addToFavorites()">Add to Favorites</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Recent Searches & Favorites -->
    <div class="col-md-4">
      <div class="card shadow mb-3">
        <div class="card-header bg-info text-white"><h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Searches</h5></div>
        <div class="card-body" id="searchHistory"><p class="text-muted">No recent searches</p></div>
      </div>

      <div class="card shadow">
        <div class="card-header bg-warning text-dark"><h5 class="mb-0"><i class="fas fa-heart me-2"></i>Favorites</h5></div>
        <div class="card-body" id="favoritesResults"><p class="text-muted">No favorite cities</p></div>
      </div>
    </div>
  </div>
</div>

<script>
let searchTimeout, currentSuggestions = [];
let currentTempCelsius = 0;

// Get JWT token from localStorage
function getToken() { return localStorage.getItem('access_token'); }

window.addEventListener('load', function () {
  const token = getToken();
  if(!token) window.location.href='/login/';

  loadUserProfile();
  loadSearchHistory();
  loadFavorites();

  document.getElementById('cityInput').addEventListener('input', handleCityInput);
  document.getElementById('cityInput').addEventListener('blur', () => setTimeout(hideSuggestions, 200));
  document.getElementById('cityInput').addEventListener('focus', () => { if(currentSuggestions.length) showSuggestions(currentSuggestions); });

  document.getElementById('weatherForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const city = document.getElementById('cityInput').value.trim();
    if(!city) return;

    try{
      const response = await fetch(`/api/weather/?city=${encodeURIComponent(city)}`, { headers: {'Authorization': `Bearer ${token}`}});
      const data = await response.json();
      if(response.ok){
        displayWeather(data);
        loadSearchHistory();
      } else alert(data.error || 'Failed to fetch weather');
    } catch(err){ alert('Error: '+err.message); }
  });
});

// Display weather and conversion
function displayWeather(data){
  currentTempCelsius = data.temperature;
  document.getElementById('cityName').textContent = `${data.city}, ${data.country}`;
  document.getElementById('description').textContent = data.description;
  updateDisplayedTemperature();
  document.getElementById('weatherResult').style.display='block';
}

function updateDisplayedTemperature(){
  const unit = document.getElementById('displayUnit').value;
  let displayTemp = '';
  switch(unit){
    case 'celsius': displayTemp = `${currentTempCelsius.toFixed(2)} °C`; break;
    case 'fahrenheit': displayTemp = `${(currentTempCelsius*9/5+32).toFixed(2)} °F`; break;
    case 'kelvin': displayTemp = `${(currentTempCelsius+273.15).toFixed(2)} K`; break;
  }
  document.getElementById('temperature').textContent = displayTemp;
}

// Favorites
async function addToFavorites(){
  const city = document.getElementById('cityName').textContent.split(',')[0];
  if(!city) return;
  const token = getToken();
  try{
    const res = await fetch('/api/weather/favorites/', {
      method:'POST',
      headers:{ 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json' },
      body: JSON.stringify({city})
    });
    if(res.ok) loadFavorites();
    else alert('Failed to add favorite');
  } catch(err){ alert(err.message); }
}

async function loadFavorites(){
  const token = getToken();
  try{
    const res = await fetch('/api/weather/favorites/', { headers:{'Authorization': `Bearer ${token}`} });
    if(res.ok){
      const data = await res.json();
      const container = document.getElementById('favoritesResults');
      if(!data.length) return container.innerHTML='<p class="text-muted">No favorite cities</p>';
      container.innerHTML = data.map(c=>`<div class="d-flex justify-content-between mb-2"><span>${c}</span><button class="btn btn-sm btn-outline-danger" onclick="removeFavorite('${c}')"><i class="fas fa-trash"></i></button></div>`).join('');
    }
  } catch(err){ console.error(err); }
}

async function removeFavorite(city){
  const token = getToken();
  try{
    const res = await fetch(`/api/weather/favorites/?city=${encodeURIComponent(city)}`, { method:'DELETE', headers:{'Authorization': `Bearer ${token}`}});
    if(res.ok) loadFavorites();
  } catch(err){ console.error(err); }
}

// Recent Searches
async function loadSearchHistory(){
  const token = getToken();
  try{
    const res = await fetch('/api/weather/history/', { headers:{'Authorization': `Bearer ${token}`} });
    if(res.ok){
      const data = await res.json();
      const container = document.getElementById('searchHistory');
      if(!data.length) return container.innerHTML='<p class="text-muted">No recent searches</p>';
      container.innerHTML = data.map(h=>`<div class="d-flex justify-content-between mb-2"><span>${h.city} (${h.temperature}°C)</span><small>${new Date(h.searched_at).toLocaleDateString()}</small></div>`).join('');
    }
  } catch(err){ console.error(err); }
}

// Mock suggestions (replace with your API if available)
function handleCityInput(e){
  const query = e.target.value.trim();
  if(searchTimeout) clearTimeout(searchTimeout);
  if(query.length>=2) searchTimeout = setTimeout(()=>fetchSuggestionsMock(query),300);
  else hideSuggestions();
}
function fetchSuggestionsMock(query){ currentSuggestions=[query+" City1",query+" City2",query+" City3"]; showSuggestions(currentSuggestions);}
function showSuggestions(s){ const dropdown=document.getElementById('suggestions'); dropdown.innerHTML=s.map(x=>`<div class="suggestion-item" onclick="selectSuggestion('${x}')">${x}</div>`).join(''); dropdown.style.display='block'; }
function hideSuggestions(){document.getElementById('suggestions').style.display='none';}
function selectSuggestion(s){document.getElementById('cityInput').value=s; hideSuggestions();}

// User Profile
async function loadUserProfile(){
  const token = getToken();
  try{
    const res = await fetch('/api/auth/profile/', { headers:{'Authorization': `Bearer ${token}`} });
    if(res.ok){ const user=await res.json(); document.getElementById('userInfo').textContent=`Welcome, ${user.username}!`; }
  } catch(err){ console.error(err); }
}

function logout(){ localStorage.clear(); window.location.href='/login/'; }

</script>

</body>
</html>
